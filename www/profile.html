<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mine Pool - Player Profile">
    <title>Player Profile | Mine Pool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/profile-premium.css">
</head>

<body>
    <div class="profile-container">
        <header class="profile-header">
            <a href="index.html" class="back-btn">
                <span>‚Üê</span>
                <span>Back</span>
            </a>
            <span class="header-title">PROFILE</span>
            <button class="settings-btn" onclick="window.location.href='settings.html'">‚öôÔ∏è</button>
        </header>

        <!-- COL 1: IDENTITY -->
        <div class="profile-card glass-panel">
            <div class="avatar-section">
                <div class="avatar-container">
                    <div class="avatar-ring"></div>
                    <div class="avatar-inner">
                        <div class="avatar-image" id="avatar-display">üé±</div>
                    </div>
                    <button class="edit-avatar-btn" onclick="changeAvatar()">üì∑</button>
                </div>
                <div class="player-info-group">
                    <div class="player-name" id="player-name">Loading...</div>
                    <div class="player-id" id="player-id">ID: ------</div>
                    <div class="rank-badge">
                        <span class="level-icon" id="rank-icon">üèÜ</span>
                        <span class="rank-text" id="player-rank">BRONZE</span>
                        <span class="level-xp" id="player-elo"
                            style="margin-left: 10px; color: #aaa; font-size: 12px;">1200 ELO</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- COL 2: WALLET & STATS -->
        <div class="center-column">
            <div class="wallet-card glass-panel">
                <div class="wallet-header">
                    <div class="wallet-label">
                        <span class="wallet-icon">ü™ô</span>
                        <span>QWIN Balance</span>
                    </div>
                </div>
                <div class="balance-display">
                    <div class="balance-amount">
                        <span id="coin-balance">0</span>
                        <span style="font-size: 24px; color: #ffd700;">QWIN</span>
                    </div>
                </div>
                <div class="wallet-actions">
                    <button class="action-btn btn-deposit" onclick="depositQwin()">
                        ‚¨ÜÔ∏è Deposit
                    </button>
                    <button class="action-btn btn-withdraw" onclick="openWithdrawModal()">
                        ‚¨áÔ∏è Withdraw
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value text-blue" id="total-games">0</div>
                    <div class="stat-label">Games Played</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-gold" id="wins">0</div>
                    <div class="stat-label">Victories</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-green" id="win-rate">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-gold" id="win-streak">0</div>
                    <div class="stat-label">Best Streak</div>
                </div>
            </div>
        </div>

        <!-- COL 3: ACTIVITY -->
        <div class="right-column">
            <!-- Achievements -->
            <div class="achievements-section glass-panel">
                <div class="section-header">
                    <span class="section-title">ACHIEVEMENTS</span>
                    <span class="achievements-counter" style="color: #8892a0; font-size: 12px;"><span
                            id="unlocked-count" style="color: #00f3ff;">0</span>/50</span>
                </div>
                <div class="horizontal-scroll" id="achievements-grid">
                    <!-- Loaded dynamically -->
                </div>
                <a href="achievements.html" class="view-all"
                    style="display: block; text-align: center; margin-top: 10px;">View All Achievements ‚Üí</a>
            </div>

            <!-- Cues -->
            <div class="cues-section glass-panel">
                <div class="section-header">
                    <span class="section-title">MY CUES</span>
                    <a href="shop.html" class="view-all">Shop ‚Üí</a>
                </div>
                <div class="horizontal-scroll" id="cues-grid">
                    <!-- Loaded dynamically -->
                    <p style="color: #8892a0; padding: 10px;">Loading cues...</p>
                </div>
            </div>

            <!-- Matches -->
            <div class="matches-section glass-panel">
                <div class="section-header">
                    <span class="section-title">HISTORY</span>
                    <a href="history.html" class="view-all">View All ‚Üí</a>
                </div>
                <div id="match-history-list" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: #8892a0; text-align: center; padding: 10px;">Loading matches...</p>
                </div>
            </div>

            <!-- Logout -->
            <div class="logout-section">
                <button onclick="logout()"
                    style="width: 100%; padding: 15px; background: rgba(255, 42, 109, 0.1); border: 1px solid #ff2a6d; color: #ff2a6d; border-radius: 12px; font-family: 'Orbitron', sans-serif; font-weight: 700; cursor: pointer; transition: all 0.3s;">
                    üö™ LOGOUT
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // Rank info helper
        function getRankFromElo(elo) {
            if (elo >= 2400) return { rank: 'Grandmaster', icon: 'üëë', color: '#FF6B6B' };
            if (elo >= 2000) return { rank: 'Master', icon: 'üèÜ', color: '#C0C0C0' };
            if (elo >= 1700) return { rank: 'Diamond', icon: 'üíé', color: '#00D4FF' };
            if (elo >= 1400) return { rank: 'Platinum', icon: 'üí†', color: '#4ECDC4' };
            if (elo >= 1100) return { rank: 'Gold', icon: 'ü•á', color: '#FFD700' };
            if (elo >= 800) return { rank: 'Silver', icon: 'ü•à', color: '#A0A0A0' };
            return { rank: 'Bronze', icon: 'ü•â', color: '#CD7F32' };
        }

        // Load user data
        async function loadProfile() {
            console.log('Loading profile from API...');
            try {
                const token = localStorage.getItem('authToken');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;
                const response = await fetch('/api/auth/me', { headers, credentials: 'include' });
                const data = await response.json();

                if (data.success && data.user) {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    displayUserProfile(data.user);
                } else {
                    console.log('API failed, no user');
                    const _storedUser = localStorage.getItem('user');
                    if (!_storedUser) {
                        window.location.href = '/login.html';
                    } else {
                        window.currentUser = JSON.parse(_storedUser);
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                const _storedUser = localStorage.getItem('user');
                if (!_storedUser) {
                    window.location.href = '/login.html';
                } else {
                    window.currentUser = JSON.parse(_storedUser);
                }
            }
        }

        // CUE DEFINITIONS
        const CUE_DATA = {
            standard: { name: 'Standard', rarity: 'common', icon: '??' },
            dragons_breath: { name: "Dragon's Breath", rarity: 'legendary', icon: '??' },
            neon_striker: { name: 'Neon Striker', rarity: 'epic', icon: '?' },
            frost_bite: { name: 'Frost Bite', rarity: 'rare', icon: '??' },
            shadow_master: { name: 'Shadow Master', rarity: 'legendary', icon: '??' },
            classic_oak: { name: 'Classic Oak', rarity: 'common', icon: '??' }
        };

        function loadCues(userCues) {
            const grid = document.getElementById('cues-grid');
            if (!grid) return;

            const ownedCues = ['standard'].concat(userCues || []);
            const selectedCue = localStorage.getItem('selectedCue') || 'standard';

            let html = '';
            ownedCues.forEach(function (cueId) {
                const cue = CUE_DATA[cueId];
                if (!cue) return;

                const isEquipped = cueId === selectedCue;
                // Using new mini-card style for horizontal scroll
                html += '<div class="achievement-mini ' + cue.rarity + '" onclick="equipCue(\'' + cueId + '\')" style="min-width: 80px; height: 80px; flex-direction: column; gap: 5px; cursor: pointer; border: 1px solid ' + (isEquipped ? '#00ff9d' : 'transparent') + ';">' +
                    '<div style="font-size: 24px;">' + cue.icon + '</div>' +
                    '<div style="font-size: 10px; text-align: center; color: #fff;">' + cue.name + '</div>' +
                    (isEquipped ? '<div style="font-size: 8px; color: #00ff9d;">EQUIPPED</div>' : '') +
                    '</div>';
            });

            if (html === '') {
                html = '<p style="color: #667788; padding: 10px;">Visit the Shop to get cues!</p>';
            }

            grid.innerHTML = html;
        }

        function equipCue(cueId) {
            localStorage.setItem('selectedCue', cueId);
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            loadCues(user.cues);
            const cue = CUE_DATA[cueId];
            if (cue) alert('?? ' + cue.name + ' equipped!');
        }

        function displayUserProfile(user) {
            document.getElementById('player-name').textContent = user.username || 'Player';
            document.getElementById('player-id').textContent = 'ID: ' + (user.id || '------').toString().substring(0, 8);
            document.getElementById('coin-balance').textContent = (user.coins || 0).toLocaleString();

            const games = user.gamesPlayed || 0;
            const wins = user.gamesWon || 0;
            const winRate = games > 0 ? Math.round((wins / games) * 100) : 0;

            document.getElementById('total-games').textContent = games;
            document.getElementById('wins').textContent = wins;
            document.getElementById('win-rate').textContent = winRate + '%';
            document.getElementById('win-streak').textContent = user.winStreak || 0;

            const elo = user.elo || 1200;
            const rankInfo = getRankFromElo(elo);
            document.getElementById('player-rank').textContent = rankInfo.rank.toUpperCase();
            document.getElementById('player-rank').style.color = rankInfo.color;
            document.getElementById('rank-icon').textContent = rankInfo.icon;
            document.getElementById('player-elo').textContent = elo + ' ELO';

            const avatarDisplay = document.getElementById('avatar-display');
            if (user.profilePicture) {
                avatarDisplay.innerHTML = '<img src="' + user.profilePicture + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
            } else {
                avatarDisplay.textContent = (user.username || 'P').charAt(0).toUpperCase();
            }

            loadCues(user.cues);
            loadAchievements();
            loadMatchHistory();
        }

        async function loadAchievements() {
            try {
                const response = await fetch('/api/achievements', { credentials: 'include' });
                const data = await response.json();

                const grid = document.getElementById('achievements-grid');
                grid.innerHTML = '';

                if (data.success) {
                    const earned = data.earned || [];
                    const locked = data.locked || [];

                    document.getElementById('unlocked-count').textContent = earned.length;

                    const toShow = [...earned.slice(0, 5), ...locked.slice(0, 5)];

                    toShow.forEach(ach => {
                        const mini = document.createElement('div');
                        mini.className = 'achievement-mini ' + (ach.unlocked ? 'unlocked' : 'locked');
                        mini.title = ach.name;
                        mini.innerHTML = ach.icon || 'üîí';
                        grid.appendChild(mini);
                    });
                }
            } catch (error) {
                console.log('Achievements not available');
            }
        }

        async function loadMatchHistory() {
            try {
                const response = await fetch('/api/matches?limit=5', { credentials: 'include' });
                const data = await response.json();
                const list = document.getElementById('match-history-list');

                if (data.success && data.matches && data.matches.length > 0) {
                    list.innerHTML = data.matches.map(match => {
                        const isWin = match.isWinner;
                        const coinsColor = match.coinsChange >= 0 ? '#00ff9d' : '#ff2a6d';
                        return '<div class="match-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">' +
                            '<div>' +
                            '<div style="font-weight: 700; color: ' + (isWin ? '#00ff9d' : '#ff2a6d') + ';">' + (isWin ? 'VICTORY' : 'DEFEAT') + '</div>' +
                            '<div style="font-size: 11px; color: #8892a0;">vs ' + (isWin ? match.loserUsername : match.winnerUsername) + '</div>' +
                            '</div>' +
                            '<div style="text-align: right;">' +
                            '<div style="color: ' + coinsColor + ';">' + (match.coinsChange >= 0 ? '+' : '') + match.coinsChange + '</div>' +
                            '</div>' +
                            '</div>';
                    }).join('');
                } else {
                    list.innerHTML = '<p style="color: #8892a0; text-align: center; padding: 10px;">No matches yet.</p>';
                }
            } catch (error) {
                console.log('Match history not available');
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login.html';
            }
        }

        function changeAvatar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/jpeg,image/png,image/gif,image/webp';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('avatar', file);
                await fetch('/api/profile/avatar', { method: 'POST', body: formData, credentials: 'include' });
                loadProfile();
            };
            input.click();
        }

        // Deposit Logic
        function openDepositModal() {
            document.getElementById('deposit-modal').style.display = 'flex';
        }

        function closeDepositModal() {
            document.getElementById('deposit-modal').style.display = 'none';
        }

        async function confirmDeposit() {
            const amount = document.getElementById('deposit-amount').value;
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'Confirming...';
            btn.disabled = true;

            try {
                if (!window.ethereum) throw new Error('MetaMask not found');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const from = accounts[0];
                const treasury = '0xdB6Be62B413dF944d5ABa396F352B8c90b0D0cb8';
                const qwinContract = '0x4bdef5d6eeD17bB3c09e6678ce9690E4E4c7bA8e';
                const amountWei = BigInt(Math.floor(amount * 10 ** 18)).toString(16).padStart(64, '0');
                const treasuryPad = treasury.substring(2).padStart(64, '0');
                const data = '0xa9059cbb' + treasuryPad + amountWei;

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{ from: from, to: qwinContract, data: data }]
                });

                alert('Transaction sent! Waiting for confirmation...');
                btn.innerText = 'Verifying...';
                await new Promise(r => setTimeout(r, 5000));

                const response = await fetch('/api/wallet/deposit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ txHash }),
                    credentials: 'include'
                });
                const resData = await response.json();
                if (resData.success) {
                    alert(`Success! Deposited ${resData.amount} QWIN.`);
                    closeDepositModal();
                    loadProfile();
                } else {
                    alert('Verification failed: ' + resData.error);
                }
            } catch (error) {
                console.error('Deposit error:', error);
                alert('Deposit failed: ' + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function depositQwin() { openDepositModal(); }

        // Withdrawal Logic
        function openWithdrawModal() {
            document.getElementById('withdraw-modal').style.display = 'flex';
        }

        function closeWithdrawModal() {
            document.getElementById('withdraw-modal').style.display = 'none';
        }

        async function confirmWithdraw() {
            const amount = document.getElementById('withdraw-amount').value;
            if (!amount || amount < 50) {
                alert('Minimum withdrawal is 50 QWIN');
                return;
            }
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'Processing...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/wallet/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseFloat(amount) }),
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success) {
                    alert('Withdrawal successful!\nTx: ' + data.txHash);
                    closeWithdrawModal();
                    loadProfile();
                } else {
                    alert('Withdrawal failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Withdrawal error:', error);
                alert('Network error.');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        loadProfile();
    </script>

    <!-- Deposit Modal -->
    <div id="deposit-modal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center;">
            <h2 style="color: #fff; margin-bottom: 10px; font-family: 'Orbitron', sans-serif;">Deposit QWIN</h2>
            <p style="color: #8892a0; margin-bottom: 20px; font-size: 14px;">Send QWIN to Game Wallet</p>
            <input type="number" id="deposit-amount" placeholder="Amount"
                style="width: 100%; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 18px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="closeDepositModal()"
                    style="flex: 1; padding: 15px; background: #334; color: #fff; border: none; border-radius: 10px; cursor: pointer;">Cancel</button>
                <button onclick="confirmDeposit()"
                    style="flex: 1; padding: 15px; background: linear-gradient(135deg, #00ff88, #00cc66); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdraw-modal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center;">
            <h2 style="color: #fff; margin-bottom: 10px; font-family: 'Orbitron', sans-serif;">Withdraw QWIN</h2>
            <p style="color: #8892a0; margin-bottom: 20px; font-size: 14px;">Min: 50 QWIN</p>
            <input type="number" id="withdraw-amount" placeholder="Amount"
                style="width: 100%; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 18px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="closeWithdrawModal()"
                    style="flex: 1; padding: 15px; background: #334; color: #fff; border: none; border-radius: 10px; cursor: pointer;">Cancel</button>
                <button onclick="confirmWithdraw()"
                    style="flex: 1; padding: 15px; background: linear-gradient(135deg, #00d4ff, #0088aa); color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">Confirm</button>
            </div>
        </div>
    </div>
</body>

</html>