<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mine Pool | Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="player-info.css?v=5">
    <link rel="stylesheet" href="turn-bar-position.css?v=2">
    <link rel="stylesheet" href="mobile-app.css">
    <link rel="stylesheet" href="mobile-landscape.css?v=3">
    <link rel="stylesheet" href="chat-updates.css">
    <link rel="stylesheet" href="modern-design.css">
    <link rel="stylesheet" href="stake-modes.css">
    <link rel="stylesheet" href="css/mobile-layout.css?v=3">
    <style>
        .user-menu {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 25px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #0088aa);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-coins {
            font-size: 12px;
            color: #ffd700;
        }

        .btn-logout {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.4);
            color: #ff6b6b;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-loading.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 212, 255, 0.2);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Hide start screen - game starts directly */
        #start-screen {
            display: none !important;
        }

        /* Show game elements by default */
        #game-header,
        #game-main,
        #controls-hint {
            display: flex !important;
        }
    </style>
    <script>
        // Lock screen to landscape for the game page
        document.addEventListener('DOMContentLoaded', function () {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(function (err) {
                    console.log('Could not lock orientation:', err.message);
                });
            }
        });
    </script>
</head>

<body class="game-page game-active">
    <!-- Rotate device overlay for portrait mode -->
    <div class="rotate-device-overlay" id="rotate-overlay">
        <div class="rotate-icon">üì±</div>
        <h2>ROTATE YOUR DEVICE</h2>
        <p>Please turn your phone sideways for the best experience</p>
    </div>

    <div id="auth-loading" class="auth-loading">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <div id="user-menu" class="user-menu" style="display:none;">
        <div class="user-info" onclick="window.location.href='profile.html'">
            <div class="user-avatar" id="user-avatar">P</div>
            <div class="user-details">
                <span class="user-name" id="user-name">Player</span>
                <span class="user-coins">&#128176; <span id="user-coins">1000</span></span>
            </div>
        </div>
        <button class="btn-logout" id="logout-btn">Logout</button>
    </div>

    <div id="game-container">
        <header id="game-header">
            <div class="logo"><span class="logo-icon">üé±</span><span class="logo-text">MINE POOL</span></div>
            <div class="player-info">
                <div class="player player-1">
                    <div class="avatar-wrapper">
                        <img class="avatar-img" id="p1-avatar-header" src="assets/avatars/default_1.png" alt="P1"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar" id="p1-avatar-fallback" style="display:none;">P1</div>
                    </div>
                    <div class="player-details"><span class="player-name" id="p1-name">Player 1</span><span
                            class="ball-type" id="p1-ball-type">--</span></div>
                    <div class="speech-bubble hidden" id="p1-speech-bubble"></div>
                </div>
                <div class="turn-indicator" id="turn-indicator"><span class="turn-text">PLAYER 1's TURN</span><span
                        class="timer-text" id="timer-text"></span></div>
                <div class="player player-2" style="cursor: pointer;" onclick="showOpponentProfile()" title="Click to view opponent profile">
                    <div class="player-details"><span class="player-name" id="p2-name">Player 2</span><span
                            class="ball-type" id="p2-ball-type">--</span></div>
                    <div class="avatar-wrapper">
                        <img class="avatar-img" id="p2-avatar-header" src="assets/avatars/default_2.png" alt="P2"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar" id="p2-avatar-fallback" style="display:none;">P2</div>
                    </div>
                    <div class="speech-bubble hidden" id="p2-speech-bubble"></div>
                </div>
            </div>
        </header>

        <main id="game-main">
            <button id="btn-back-to-menu" class="back-btn" title="Back to Menu">‚ùÆ</button>
            <div id="table-container">
                <canvas id="pool-table"></canvas>
                <div id="power-gauge">
                    <div class="power-label">POWER</div>
                    <div class="power-bar">
                        <div class="power-fill" id="power-fill"></div>
                        <div id="power-handle"></div>
                    </div>
                    <div class="power-value" id="power-value">0%</div>
                </div>
                <div id="spin-control">
                    <div class="spin-label">ENGLISH</div>
                    <div class="spin-ball" id="spin-ball-control">
                        <div class="spin-indicator" id="spin-indicator"></div>
                        <div class="spin-crosshair"></div>
                    </div>
                    <div class="spin-info" id="spin-info">Center Hit</div><button class="reset-spin"
                        id="reset-spin">RESET</button>
                </div>
            </div>
            <div id="ball-rack">
                <div class="rack-section solids">
                    <div class="rack-label">SOLIDS</div>
                    <div class="rack-balls" id="solids-rack"></div>
                </div>
                <div class="rack-section stripes">
                    <div class="rack-label">STRIPES</div>
                    <div class="rack-balls" id="stripes-rack"></div>
                </div>
            </div>
        </main>

        <div id="game-message" class="hidden">
            <div class="message-content">
                <h2 id="message-title">FOUL!</h2>
                <p id="message-text">Cue ball pocketed. Ball in hand.</p>
            </div>
        </div>

        <div id="call-pocket-modal" class="hidden">
            <div class="modal-overlay"></div>
            <div class="call-pocket-content">
                <h2>üéØ CALL YOUR POCKET</h2>
                <p>Select which pocket for the 8-ball</p>
                <div class="pocket-grid">
                    <button class="pocket-btn" data-pocket="0"><span class="pocket-label">Top Left</span><span
                            class="pocket-icon">‚ÜñÔ∏è</span></button>
                    <button class="pocket-btn" data-pocket="1"><span class="pocket-label">Top Center</span><span
                            class="pocket-icon">‚¨ÜÔ∏è</span></button>
                    <button class="pocket-btn" data-pocket="2"><span class="pocket-label">Top Right</span><span
                            class="pocket-icon">‚ÜóÔ∏è</span></button>
                    <button class="pocket-btn" data-pocket="3"><span class="pocket-label">Bottom Left</span><span
                            class="pocket-icon">‚ÜôÔ∏è</span></button>
                    <button class="pocket-btn" data-pocket="4"><span class="pocket-label">Bottom Center</span><span
                            class="pocket-icon">‚¨áÔ∏è</span></button>
                    <button class="pocket-btn" data-pocket="5"><span class="pocket-label">Bottom Right</span><span
                            class="pocket-icon">‚ÜòÔ∏è</span></button>
                </div>
            </div>
        </div>

        <div id="winner-screen" class="hidden">
            <div class="winner-content">
                <div class="trophy">üèÜ</div>
                <h1 id="winner-text">PLAYER 1 WINS!</h1>
                <button id="play-again" class="btn-primary">PLAY AGAIN</button>
                <button id="back-to-menu" class="btn-secondary" style="margin-top: 10px;">BACK TO MENU</button>
            </div>
        </div>

        <!-- Chat Panel -->
        <div id="chat-panel">
            <div class="chat-toggle" id="chat-toggle">
                <span class="chat-icon">üí¨</span>
                <span class="chat-badge" id="chat-badge"></span>
            </div>
            <div class="chat-container" id="chat-container">
                <div class="chat-header">
                    <span>üí¨ CHAT</span>
                    <button class="chat-close" id="chat-close">‚úï</button>
                </div>
                <div class="quick-chat">
                    <button class="quick-btn" data-msg="Good luck!">üçÄ Good luck!</button>
                    <button class="quick-btn" data-msg="Nice shot!">üëè Nice shot!</button>
                    <button class="quick-btn" data-msg="Oops!">üòÖ Oops!</button>
                    <button class="quick-btn" data-msg="Well played!">üéØ Well played!</button>
                    <button class="quick-btn" data-msg="Your turn!">‚è∞ Your turn!</button>
                    <button class="quick-btn" data-msg="GG">üèÜ GG</button>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Type a message..." maxlength="100">
                    <button id="chat-send">‚û§</button>
                </div>
            </div>
        </div>

        <div id="controls-hint"><span>üñ±Ô∏è CLICK TO LOCK AIM</span><span>‚¨ÖÔ∏è DRAG BACK FOR POWER</span><span>üéØ RELEASE TO
                SHOOT</span></div>
    </div>

    <script>
        // Get game mode from URL
        const urlParams = new URLSearchParams(window.location.search);
        const gameMode = urlParams.get('mode') || 'online';
        const gameId = urlParams.get('gameId');
        window.gameMode = gameMode;

        // For online mode with no gameId, hide game container until match is found
        // If gameId exists, we're coming from matchmaking.html with a found match - show immediately
        if (gameMode === 'online') {
            if (gameId) {
                // Coming from matchmaking.html with a found match - show the table immediately
                document.body.classList.add('match-ready');
                console.log('üéÆ Game ready - match already found, showing table');
            } else {
                // Fresh online matchmaking - hide until match is found
                document.body.classList.add('online-matchmaking');
            }
        }
        console.log('üéÆ Game mode:', gameMode, '| Game ID:', gameId || 'none');

        // Authentication check
        (async function checkAuth() {
            const loadingEl = document.getElementById('auth-loading');
            const userMenuEl = document.getElementById('user-menu');
            try {
                const response = await fetch('/api/auth/me', { credentials: 'include' });
                const data = await response.json();
                if (data.success && data.user) {
                    document.getElementById('user-name').textContent = data.user.username;
                    document.getElementById('user-coins').textContent = data.user.coins || 1000;
                    document.getElementById('user-avatar').textContent = data.user.username.charAt(0).toUpperCase();
                    const p1NameEl = document.getElementById('p1-name');
                    if (p1NameEl) p1NameEl.textContent = data.user.username;
                    window.currentUser = data.user;

                    // Update Player 1 avatar from profilePicture
                    const p1AvatarHeader = document.getElementById('p1-avatar-header');
                    const p1AvatarFallback = document.getElementById('p1-avatar-fallback');
                    if (data.user.profilePicture) {
                        if (p1AvatarHeader) { p1AvatarHeader.src = data.user.profilePicture; p1AvatarHeader.style.display = 'block'; }
                        if (p1AvatarFallback) p1AvatarFallback.style.display = 'none';
                    }
                    if (window.playerInfoManager && window.playerInfoManager.updatePlayer1Info) {
                        window.playerInfoManager.updatePlayer1Info(data.user);
                    }

                    loadingEl.classList.add('hidden');
                    userMenuEl.style.display = 'flex';
                } else {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        })();

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); } catch (e) { }
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        });

        // Back button handler
        document.getElementById('btn-back-to-menu').addEventListener('click', () => {
            if (confirm('Leave the game? You may lose progress.')) {
                window.location.href = '/index.html';
            }
        });

        // Play again handler
        document.getElementById('play-again')?.addEventListener('click', () => {
            window.location.reload();
        });

        // Back to menu from winner screen
        document.getElementById('back-to-menu')?.addEventListener('click', () => {
            window.location.href = '/index.html';
        });

        // Chat functionality
        document.addEventListener('DOMContentLoaded', () => {
            const chatToggle = document.getElementById('chat-toggle');
            const chatContainer = document.getElementById('chat-container');
            const chatClose = document.getElementById('chat-close');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const chatBadge = document.getElementById('chat-badge');
            const quickBtns = document.querySelectorAll('.quick-btn');

            let unreadCount = 0;
            let isOpen = false;

            // Toggle chat
            chatToggle.addEventListener('click', () => {
                isOpen = !isOpen;
                chatContainer.classList.toggle('open', isOpen);
                if (isOpen) {
                    unreadCount = 0;
                    chatBadge.textContent = '';
                    chatBadge.style.display = 'none';
                    chatInput.focus();
                }
            });

            chatClose.addEventListener('click', () => {
                isOpen = false;
                chatContainer.classList.remove('open');
            });

            // Send message
            function sendMessage() {
                const message = chatInput.value.trim();
                if (message && window.networkManager) {
                    window.networkManager.sendMessage(message);
                    chatInput.value = '';
                }
            }

            chatSend.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Quick chat
            quickBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const msg = btn.dataset.msg;
                    if (window.networkManager) {
                        window.networkManager.sendMessage(msg);
                    }
                });
            });

            // Add message to chat (exposed globally)
            window.addChatMessage = function (username, message, isMe = false) {
                let bubbleId;

                if (window.gameInstance && window.gameInstance.isMultiplayer) {
                    const myPlayerNum = window.gameInstance.myPlayerNumber;
                    if (isMe) {
                        bubbleId = (myPlayerNum === 1) ? 'p1-speech-bubble' : 'p2-speech-bubble';
                    } else {
                        bubbleId = (myPlayerNum === 1) ? 'p2-speech-bubble' : 'p1-speech-bubble';
                    }
                } else {
                    bubbleId = isMe ? 'p1-speech-bubble' : 'p2-speech-bubble';
                }

                const bubble = document.getElementById(bubbleId);

                if (bubble) {
                    bubble.textContent = message;
                    bubble.classList.remove('hidden');
                    bubble.classList.add('visible');

                    if (bubble.hideTimeout) clearTimeout(bubble.hideTimeout);
                    bubble.hideTimeout = setTimeout(() => {
                        bubble.classList.remove('visible');
                        bubble.classList.add('hidden');
                    }, 4000);
                }
            };
        });

        // Show opponent profile when clicking on Player 2
        function showOpponentProfile() {
            const opponentData = window.opponentData || {
                id: 'opponent',
                username: document.getElementById('p2-name')?.textContent || 'Player 2',
                elo: 1200,
                gamesPlayed: 0,
                gamesWon: 0,
                online: true,
                inGame: true
            };
            
            if (window.playerProfileViewer) {
                window.playerProfileViewer.show(opponentData.id, opponentData);
            }
        }
    </script>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="physics.js?v=17"></script>
    <script src="game.js?v=23"></script>
    <script src="network.js?v=2"></script>
    <script src="matchmaking.js?v=4"></script>
    <script src="player-info.js?v=3"></script>
    <script src="turn-bar-position.js?v=2"></script>
    <script src="js/player-profile-viewer.js?v=1"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (window.currentUser && typeof io !== 'undefined') {
                    window.networkManager = new NetworkManager(window.gameInstance);
                    window.networkManager.connect().then(() => {
                        console.log('üåê Connected to multiplayer server');
                        window.matchmakingUI = new MatchmakingUI(window.networkManager);

                        // Auto-start based on game mode
                        if (window.gameMode === 'online') {
                            // Show matchmaking UI for online play
                            setTimeout(() => {
                                window.matchmakingUI.show();
                            }, 500);
                        } else if (window.gameMode === '2player') {
                            // Start 2-player local game immediately
                            if (window.gameInstance) {
                                window.gameInstance.startGame('2player');
                            }
                        }

                        // Prevent duplicate chat listener registration
                        if (!window.chatListenerRegistered) {
                            window.chatListenerRegistered = true;

                            let lastMessageKey = '';
                            let lastMessageTime = 0;

                            window.networkManager.on('chat_message', (data) => {
                                console.log('üí¨ Chat message received:', data);

                                const messageKey = `${data.username}:${data.message}`;
                                const now = Date.now();

                                if (messageKey === lastMessageKey && (now - lastMessageTime) < 500) {
                                    console.log('üí¨ Duplicate message ignored');
                                    return;
                                }

                                lastMessageKey = messageKey;
                                lastMessageTime = now;

                                if (window.addChatMessage) {
                                    const isMe = data.username === window.currentUser?.username;
                                    window.addChatMessage(data.username || 'Player', data.message, isMe);
                                }
                            });
                        }
                    }).catch(err => {
                        console.error('Failed to connect:', err);
                        // If online mode fails, offer fallback
                        if (window.gameMode === 'online') {
                            alert('Could not connect to server. Starting local game.');
                            if (window.gameInstance) {
                                window.gameInstance.startGame('2player');
                            }
                        }
                    });
                }
            }, 1000);
        });
    </script>
</body>

</html>