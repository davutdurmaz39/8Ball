<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8 Ball Pool | Multiplayer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="player-info.css?v=5">
    <link rel="stylesheet" href="turn-bar-position.css">
    <link rel="stylesheet" href="mobile-landscape.css?v=2">
    <style>
        .user-menu {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 25px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #0088aa);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-coins {
            font-size: 12px;
            color: #ffd700;
        }

        .btn-logout {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.4);
            color: #ff6b6b;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-loading.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 212, 255, 0.2);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-online-play {
            position: relative;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 136, 170, 0.2)) !important;
            border-color: #00d4ff !important;
        }

        .btn-online-play:hover {
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.4) !important;
        }

        .online-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #00ff88, #00aa55);
            color: #000;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }
    </style>
</head>

<body>
    <!-- Rotate device overlay for portrait mode -->
    <div class="rotate-device-overlay" id="rotate-overlay">
        <div class="rotate-icon">üì±</div>
        <h2>ROTATE YOUR DEVICE</h2>
        <p>Please turn your phone sideways for the best experience</p>
    </div>

    <div id="auth-loading" class="auth-loading">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
    <div id="user-menu" class="user-menu" style="display:none;">
        <div class="user-info" onclick="window.location.href='profile.html'">
            <div class="user-avatar" id="user-avatar">P</div>
            <div class="user-details">
                <span class="user-name" id="user-name">Player</span>
                <span class="user-coins">&#128176; <span id="user-coins">1000</span></span>
            </div>
        </div>
        <button class="btn-logout" id="logout-btn">Logout</button>
    </div>
    <div id="game-container">
        <header id="game-header">
            <div class="logo"><span class="logo-icon">üé±</span><span class="logo-text">8 BALL POOL</span></div>
            <div class="player-info">
                <div class="player player-1">
                    <div class="avatar">P1</div>
                    <div class="player-details"><span class="player-name" id="p1-name">Player 1</span><span
                            class="ball-type" id="p1-ball-type">--</span></div>
                </div>
                <div class="turn-indicator" id="turn-indicator"><span class="turn-text">PLAYER 1's TURN</span><span
                        class="timer-text" id="timer-text"></span></div>
                <div class="player player-2">
                    <div class="player-details"><span class="player-name" id="p2-name">Player 2</span><span
                            class="ball-type" id="p2-ball-type">--</span></div>
                    <div class="avatar">P2</div>
                </div>
            </div>
        </header>
        <main id="game-main">
            <div id="table-container">
                <canvas id="pool-table"></canvas>
                <div id="power-gauge">
                    <div class="power-label">POWER</div>
                    <div class="power-bar">
                        <div class="power-fill" id="power-fill"></div>
                        <div id="power-handle"></div>
                    </div>
                    <div class="power-value" id="power-value">0%</div>
                </div>
                <div id="spin-control">
                    <div class="spin-label">ENGLISH</div>
                    <div class="spin-ball" id="spin-ball-control">
                        <div class="spin-indicator" id="spin-indicator"></div>
                        <div class="spin-crosshair"></div>
                    </div>
                    <div class="spin-info" id="spin-info">Center Hit</div><button class="reset-spin"
                        id="reset-spin">RESET</button>
                </div>
            </div>
            <div id="ball-rack">
                <div class="rack-section solids">
                    <div class="rack-label">SOLIDS</div>
                    <div class="rack-balls" id="solids-rack"></div>
                </div>
                <div class="rack-section stripes">
                    <div class="rack-label">STRIPES</div>
                    <div class="rack-balls" id="stripes-rack"></div>
                </div>
            </div>
        </main>
        <div id="game-message" class="hidden">
            <div class="message-content">
                <h2 id="message-title">FOUL!</h2>
                <p id="message-text">Cue ball pocketed. Ball in hand.</p>
            </div>
        </div>
        <div id="call-pocket-modal" class="hidden">
            <div class="modal-overlay"></div>
            <div class="call-pocket-content">
                <h2>üéØ CALL YOUR POCKET</h2>
                <p>Select which pocket for the 8-ball</p>
                <div class="pocket-grid"><button class="pocket-btn" data-pocket="0"><span class="pocket-label">Top
                            Left</span><span class="pocket-icon">‚ÜñÔ∏è</span></button><button class="pocket-btn"
                        data-pocket="1"><span class="pocket-label">Top Center</span><span
                            class="pocket-icon">‚¨ÜÔ∏è</span></button><button class="pocket-btn" data-pocket="2"><span
                            class="pocket-label">Top Right</span><span class="pocket-icon">‚ÜóÔ∏è</span></button><button
                        class="pocket-btn" data-pocket="3"><span class="pocket-label">Bottom Left</span><span
                            class="pocket-icon">‚ÜôÔ∏è</span></button><button class="pocket-btn" data-pocket="4"><span
                            class="pocket-label">Bottom Center</span><span class="pocket-icon">‚¨áÔ∏è</span></button><button
                        class="pocket-btn" data-pocket="5"><span class="pocket-label">Bottom Right</span><span
                            class="pocket-icon">‚ÜòÔ∏è</span></button></div>
            </div>
        </div>
        <div id="winner-screen" class="hidden">
            <div class="winner-content">
                <div class="trophy">üèÜ</div>
                <h1 id="winner-text">PLAYER 1 WINS!</h1><button id="play-again" class="btn-primary">PLAY AGAIN</button>
            </div>
        </div>
        <div id="start-screen">
            <div class="start-content">
                <div class="start-logo"><span class="big-ball">üé±</span>
                    <h1>8 BALL POOL</h1>
                    <p class="tagline">Miniclip Rules Edition</p>
                </div>
                <div class="game-modes">
                    <button id="btn-online" class="btn-mode btn-online-play"><span class="mode-icon">üåê</span><span
                            class="mode-text">PLAY ONLINE</span><span class="online-badge">LIVE</span></button>
                    <button id="btn-2player" class="btn-mode"><span class="mode-icon">üë•</span><span class="mode-text">2
                            PLAYERS</span></button>
                    <button id="btn-cues" class="btn-mode"><span class="mode-icon">üé±</span><span
                            class="mode-text">CUES</span></button>
                </div>
                <div class="instructions">
                    <h3>HOW TO PLAY</h3>
                    <ul>
                        <li>üñ±Ô∏è Click to lock aim direction</li>
                        <li>‚¨ÖÔ∏è Drag back to set power</li>
                        <li>üîÑ Click spin control for English</li>
                        <li>üéØ Release to shoot</li>
                        <li>üé± Pocket the 8-ball last to win!</li>
                        <li>‚è±Ô∏è 30 seconds per shot</li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="cue-selection-modal" class="hidden">
            <div class="cue-modal-content">
                <h2>SELECT YOUR CUE</h2>
                <div class="cue-list">
                    <div class="cue-card active" data-cue="standard">
                        <div class="cue-image"><img src="assets/cue_standard.png" alt="Standard Cue"></div>
                        <div class="cue-info">
                            <h3>STANDARD</h3>
                            <p>Classic maple wood</p>
                        </div>
                    </div>
                    <div class="cue-card" data-cue="premium">
                        <div class="cue-image"><img src="assets/cue_premium.png" alt="Premium Cue"></div>
                        <div class="cue-info">
                            <h3>PREMIUM</h3>
                            <p>Carbon fiber tech</p>
                        </div>
                    </div>
                    <div class="cue-card" data-cue="legendary">
                        <div class="cue-image"><img src="assets/cue_legendary.png" alt="Legendary Cue"></div>
                        <div class="cue-info">
                            <h3>LEGENDARY</h3>
                            <p>Ancient power</p>
                        </div>
                    </div>
                </div><button id="close-cues" class="btn-primary">CONFIRM</button>
            </div>
        </div>

        <!-- Chat Panel -->
        <div id="chat-panel">
            <div class="chat-toggle" id="chat-toggle">
                <span class="chat-icon">üí¨</span>
                <span class="chat-badge" id="chat-badge"></span>
            </div>
            <div class="chat-container" id="chat-container">
                <div class="chat-header">
                    <span>üí¨ CHAT</span>
                    <button class="chat-close" id="chat-close">‚úï</button>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-welcome">Click a quick message or type below!</div>
                </div>
                <div class="quick-chat">
                    <button class="quick-btn" data-msg="Good luck!">üçÄ Good luck!</button>
                    <button class="quick-btn" data-msg="Nice shot!">üëè Nice shot!</button>
                    <button class="quick-btn" data-msg="Oops!">üòÖ Oops!</button>
                    <button class="quick-btn" data-msg="Well played!">üéØ Well played!</button>
                    <button class="quick-btn" data-msg="Your turn!">‚è∞ Your turn!</button>
                    <button class="quick-btn" data-msg="GG">üèÜ GG</button>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Type a message..." maxlength="100">
                    <button id="chat-send">‚û§</button>
                </div>
            </div>
        </div>

        <div id="controls-hint"><span>üñ±Ô∏è CLICK TO LOCK AIM</span><span>‚¨ÖÔ∏è DRAG BACK FOR POWER</span><span>üéØ RELEASE TO
                SHOOT</span></div>
    </div>

    <script>
        (async function checkAuth() {
            const loadingEl = document.getElementById('auth-loading');
            const userMenuEl = document.getElementById('user-menu');
            try {
                const response = await fetch('/api/auth/me', { credentials: 'include' });
                const data = await response.json();
                if (data.success && data.user) {
                    document.getElementById('user-name').textContent = data.user.username;
                    document.getElementById('user-coins').textContent = data.user.coins || 1000;
                    document.getElementById('user-avatar').textContent = data.user.username.charAt(0).toUpperCase();
                    const p1NameEl = document.getElementById('p1-name');
                    if (p1NameEl) p1NameEl.textContent = data.user.username;
                    window.currentUser = data.user;
                    loadingEl.classList.add('hidden');
                    userMenuEl.style.display = 'flex';
                } else {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        })();
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); } catch (e) { }
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        });

        // Chat functionality
        document.addEventListener('DOMContentLoaded', () => {
            const chatToggle = document.getElementById('chat-toggle');
            const chatContainer = document.getElementById('chat-container');
            const chatClose = document.getElementById('chat-close');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const chatMessages = document.getElementById('chat-messages');
            const chatBadge = document.getElementById('chat-badge');
            const quickBtns = document.querySelectorAll('.quick-btn');

            let unreadCount = 0;
            let isOpen = false;

            // Toggle chat
            chatToggle.addEventListener('click', () => {
                isOpen = !isOpen;
                chatContainer.classList.toggle('open', isOpen);
                if (isOpen) {
                    unreadCount = 0;
                    chatBadge.textContent = '';
                    chatBadge.style.display = 'none';
                    chatInput.focus();
                }
            });

            chatClose.addEventListener('click', () => {
                isOpen = false;
                chatContainer.classList.remove('open');
            });

            // Send message
            function sendMessage() {
                const message = chatInput.value.trim();
                if (message && window.networkManager) {
                    window.networkManager.sendMessage(message);
                    // Don't add message locally - wait for server to broadcast it back
                    chatInput.value = '';
                }
            }

            chatSend.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Quick chat
            quickBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const msg = btn.dataset.msg;
                    if (window.networkManager) {
                        window.networkManager.sendMessage(msg);
                        // Don't add locally - server will broadcast it back
                    }
                });
            });

            // Add message to chat (exposed globally)
            window.addChatMessage = function (username, message, isMe = false) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-msg ${isMe ? 'chat-sender' : 'opponent'}`;
                msgDiv.innerHTML = `<strong>${username}:</strong> ${message}`;
                chatMessages.appendChild(msgDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Update unread count if chat is closed
                if (!isMe && !isOpen) {
                    unreadCount++;
                    chatBadge.textContent = unreadCount;
                    chatBadge.style.display = 'block';
                }
            };

            // Local helper that uses the global function
            function addMessage(username, message, isMe) {
                window.addChatMessage(username, message, isMe);
            }
        });

    </script>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="physics.js?v=17"></script>
    <script src="game.js?v=21"></script>
    <script src="network.js?v=2"></script>
    <script src="matchmaking.js?v=4"></script>
    <script src="turn-bar-position.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (window.currentUser && typeof io !== 'undefined') {
                    window.networkManager = new NetworkManager(window.gameInstance);
                    window.networkManager.connect().then(() => {
                        console.log('üåê Connected to multiplayer server');
                        window.matchmakingUI = new MatchmakingUI(window.networkManager);
                        const onlineBtn = document.getElementById('btn-online');
                        if (onlineBtn) {
                            onlineBtn.addEventListener('click', () => {
                                window.matchmakingUI.show();
                            });
                        }

                        // Prevent duplicate chat listener registration
                        if (!window.chatListenerRegistered) {
                            window.chatListenerRegistered = true;

                            // Track last message to prevent duplicates
                            let lastMessageKey = '';
                            let lastMessageTime = 0;

                            // Set up chat listener after connection
                            window.networkManager.on('chat_message', (data) => {
                                console.log('üí¨ Chat message received:', data);

                                // Create unique key for deduplication
                                const messageKey = `${data.username}:${data.message}`;
                                const now = Date.now();

                                // Ignore if same message within 500ms
                                if (messageKey === lastMessageKey && (now - lastMessageTime) < 500) {
                                    console.log('üí¨ Duplicate message ignored');
                                    return;
                                }

                                lastMessageKey = messageKey;
                                lastMessageTime = now;

                                if (window.addChatMessage) {
                                    // Check if message is from us
                                    const isMe = data.username === window.currentUser?.username;
                                    window.addChatMessage(data.username || 'Player', data.message, isMe);
                                }
                            });
                        }
                    }).catch(err => {
                        console.error('Failed to connect:', err);
                    });
                }
            }, 1000);
        });
    </script>
</body>

</html>